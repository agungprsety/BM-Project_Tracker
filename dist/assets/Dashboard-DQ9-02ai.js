import{j as e}from"./vendor-query-dOYxXkJ3.js";import{f as G,a as c}from"./vendor-react-CfkJOBur.js";import{u as U,b as X}from"./index-DaHXQ4-S.js";import{u as O,c as J,f as A,a as Q}from"./utils-BfptotOI.js";import{e as Z}from"./exportPdf-s0IUKqir.js";import{D as F}from"./districts-Z7EIMGL1.js";import{B as k,C as g}from"./Button-Dqt4D0nT.js";import{j as ee,f as se,g as te,k as ae,l as re,h as le,C as ie}from"./vendor-icons-Jh-DJkRq.js";import{R as oe,B as ce,X as ne,Y as de,T as xe,a as me,C as he}from"./vendor-charts-D7W35Enl.js";import"./vendor-pdf-D-ScUWta.js";import"./vendor-supabase-Dq-Jb853.js";const y=10,L=[{label:"0–25%",key:"low",color:"#dc2626",min:0,max:25},{label:"25–50%",key:"mid",color:"#d97706",min:25,max:50},{label:"50–75%",key:"high",color:"#2563eb",min:50,max:75},{label:"75–100%",key:"done",color:"#16a34a",min:75,max:101}];function ke(){const S=G(),{darkMode:r}=U(),{data:u=[],isLoading:B}=O(),{t:l}=X(),[b,D]=c.useState(""),[j,R]=c.useState("progress"),[C,$]=c.useState("asc"),[T,n]=c.useState(1),[h,N]=c.useState(null),[d,P]=c.useState(""),[f,w]=c.useState(""),x=c.useMemo(()=>u.map(s=>{var t;return{...s,_progress:J(s.boq||[],s.weeklyReports||[]),_value:((t=s.boq)==null?void 0:t.reduce((a,i)=>a+i.quantity*i.unitPrice,0))||0}}),[u]),E=x.reduce((s,t)=>s+t._value,0),W=x.length>0?x.reduce((s,t)=>s+t._progress,0)/x.length:0,H=x.reduce((s,t)=>s+(t.length||0),0),v=c.useMemo(()=>{let s=[...x];if(b){const t=b.toLowerCase();s=s.filter(a=>a.name.toLowerCase().includes(t)||a.contractor.toLowerCase().includes(t)||a.supervisor.toLowerCase().includes(t))}return d&&(s=s.filter(t=>t.district===d)),f&&(s=s.filter(t=>t.subDistrict===f)),s},[x,b,d,f]),_=c.useMemo(()=>L.map(s=>({...s,count:v.filter(t=>t._progress>=s.min&&t._progress<s.max).length})),[v]),K=c.useMemo(()=>{if(!d)return[];const s=F.find(t=>t.name===d);return s?s.subDistricts:[]},[d]),p=c.useMemo(()=>{let s=[...v];if(h){const t=L.find(a=>a.key===h);t&&(s=s.filter(a=>a._progress>=t.min&&a._progress<t.max))}return s.sort((t,a)=>{let i=0;switch(j){case"name":i=t.name.localeCompare(a.name);break;case"contractor":i=t.contractor.localeCompare(a.contractor);break;case"supervisor":i=t.supervisor.localeCompare(a.supervisor);break;case"progress":i=t._progress-a._progress;break;case"value":i=t._value-a._value;break;case"district":i=(t.district||"").localeCompare(a.district||"");break;case"subDistrict":i=(t.subDistrict||"").localeCompare(a.subDistrict||"");break;case"averageWidth":i=(t.averageWidth||0)-(a.averageWidth||0);break;case"length":i=(t.length||0)-(a.length||0);break;case"roadHierarchy":i=(t.roadHierarchy||"").localeCompare(a.roadHierarchy||"");break}return C==="asc"?i:-i}),s},[v,h,j,C]),m=Math.max(1,Math.ceil(p.length/y)),o=Math.min(T,m),M=p.slice((o-1)*y,o*y),q=h||d||f||b,V=()=>{N(null),P(""),w(""),D(""),n(1)},I=s=>{j===s?$(C==="asc"?"desc":"asc"):(R(s),$("asc")),n(1)},Y=s=>s>=75?"bg-green-500":s>=50?"bg-blue-500":s>=25?"bg-amber-500":"bg-red-500",z=`px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${r?"bg-gray-700 border-gray-600 text-white":"bg-white border-gray-300"}`;return B?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"max-w-7xl mx-auto",children:[u.length>0&&e.jsx("div",{className:"flex justify-end mb-4",children:e.jsxs(k,{variant:"secondary",size:"sm",onClick:()=>Z(u),children:[e.jsx(ee,{size:16,className:"mr-2"})," Export PDF"]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8",children:[e.jsxs(g,{darkMode:r,children:[e.jsx("p",{className:`text-sm font-medium mb-2 ${r?"text-gray-400":"text-gray-600"}`,children:l("dashboard.totalProjects")}),e.jsx("p",{className:"text-3xl font-bold",children:u.length})]}),e.jsxs(g,{darkMode:r,children:[e.jsx("p",{className:`text-sm font-medium mb-2 ${r?"text-gray-400":"text-gray-600"}`,children:l("dashboard.totalValue")}),e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:A(E)})]}),e.jsxs(g,{darkMode:r,children:[e.jsx("p",{className:`text-sm font-medium mb-2 ${r?"text-gray-400":"text-gray-600"}`,children:l("dashboard.avgProgress")}),e.jsxs("p",{className:"text-2xl font-bold text-green-600",children:[W.toFixed(1),"%"]})]}),e.jsxs(g,{darkMode:r,children:[e.jsx("p",{className:`text-sm font-medium mb-2 ${r?"text-gray-400":"text-gray-600"}`,children:"Total Length"}),e.jsx("p",{className:"text-2xl font-bold text-purple-600",children:Q(H)})]})]}),u.length===0?e.jsxs(g,{darkMode:r,className:"text-center py-12",children:[e.jsx("p",{className:`text-lg mb-4 ${r?"text-gray-400":"text-gray-600"}`,children:"No projects yet"}),e.jsx(k,{onClick:()=>S("/projects/new"),children:"Create Your First Project"})]}):e.jsxs(e.Fragment,{children:[e.jsxs(g,{darkMode:r,className:"mb-8",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:l("dashboard.progressDist")}),e.jsx("p",{className:`text-sm ${r?"text-gray-400":"text-gray-500"}`,children:"Click a bar to filter the table below"})]}),h&&e.jsx("button",{onClick:()=>{N(null),n(1)},className:"text-sm text-blue-600 hover:text-blue-700 font-medium",children:"Clear filter ×"})]}),e.jsx(oe,{width:"100%",height:250,children:e.jsxs(ce,{data:_,margin:{left:30,right:20,top:20,bottom:25},children:[e.jsx(ne,{dataKey:"label",tick:{fontSize:12},label:{value:l("dashboard.xAxis"),position:"insideBottom",offset:-20,fontSize:12}}),e.jsx(de,{allowDecimals:!1,tick:{fontSize:12},label:{value:l("dashboard.yAxis"),angle:-90,position:"insideLeft",offset:-15,fontSize:12}}),e.jsx(xe,{formatter:s=>[`${s} ${l("dashboard.tooltip")}`,"Count"],contentStyle:r?{backgroundColor:"#1f2937",border:"1px solid #374151",borderRadius:"8px"}:{borderRadius:"8px"}}),e.jsx(me,{dataKey:"count",radius:[4,4,0,0],maxBarSize:60,cursor:"pointer",onClick:s=>{h===s.key?N(null):N(s.key),n(1)},children:_.map((s,t)=>e.jsx(he,{fill:s.color,opacity:h&&h!==s.key?.3:1},t))})]})})]}),e.jsxs(g,{darkMode:r,children:[e.jsxs("div",{className:"flex flex-col gap-3 mb-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:[l("dashboard.title"),p.length!==x.length&&e.jsxs("span",{className:`text-sm font-normal ml-2 ${r?"text-gray-400":"text-gray-500"}`,children:["(",p.length," of ",x.length,")"]})]}),e.jsxs("div",{className:"relative w-full sm:w-64",children:[e.jsx(se,{size:16,className:`absolute left-3 top-1/2 -translate-y-1/2 ${r?"text-gray-500":"text-gray-400"}`}),e.jsx("input",{type:"text",placeholder:l("dashboard.search"),value:b,onChange:s=>{D(s.target.value),n(1)},className:`w-full pl-9 pr-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${r?"bg-gray-700 border-gray-600 text-white placeholder-gray-400":"bg-white border-gray-300 placeholder-gray-400"}`})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx(te,{size:16,className:r?"text-gray-400":"text-gray-500"}),e.jsxs("select",{value:d,onChange:s=>{P(s.target.value),w(""),n(1)},className:z,children:[e.jsx("option",{value:"",children:l("dashboard.allDistricts")}),F.map(s=>e.jsx("option",{value:s.name,children:s.name},s.code))]}),e.jsxs("select",{value:f,onChange:s=>{w(s.target.value),n(1)},className:z,disabled:!d,children:[e.jsx("option",{value:"",children:l("dashboard.allSubDistricts")}),K.map(s=>e.jsx("option",{value:s,children:s},s))]}),q&&e.jsx("button",{onClick:V,className:"text-sm text-blue-600 hover:text-blue-700 font-medium ml-auto",children:"Clear all filters ×"})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:r?"bg-gray-700 text-gray-300":"bg-gray-50 text-gray-500",children:[[["name",l("dashboard.thProject")],["contractor",l("dashboard.thContractor")],["supervisor",l("dashboard.thConsultant")],["district",l("dashboard.thDistrict")],["subDistrict",l("dashboard.thSubDistrict")],["averageWidth",l("dashboard.thAvgWidth")],["length",l("dashboard.thLength")],["roadHierarchy",l("dashboard.thHierarchy")],["progress",l("dashboard.thProgress")],["value",l("dashboard.thValue")]].map(([s,t])=>e.jsx("th",{className:"px-3 py-3 text-left text-xs font-medium cursor-pointer select-none hover:text-blue-600 transition-colors whitespace-nowrap",onClick:()=>I(s),children:e.jsxs("span",{className:"flex items-center gap-1",children:[t,e.jsx(ae,{size:11,className:j===s?"text-blue-500":"opacity-40"})]})},s)),e.jsx("th",{className:"px-3 py-3 text-left text-xs font-medium",children:l("dashboard.thActions")})]})}),e.jsx("tbody",{children:M.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:11,className:"px-4 py-8 text-center",children:e.jsx("p",{className:r?"text-gray-400":"text-gray-500",children:l("dashboard.noProjects")})})}):M.map(s=>e.jsxs("tr",{className:`border-t ${r?"border-gray-700 hover:bg-gray-700":"border-gray-200 hover:bg-gray-50"} transition-colors`,children:[e.jsxs("td",{className:"px-3 py-3",children:[e.jsx("div",{className:"font-medium",children:s.name}),s.location&&e.jsxs("div",{className:`text-xs ${r?"text-gray-400":"text-gray-500"}`,children:[e.jsx(re,{size:10,className:"inline mr-0.5"}),"GPS"]})]}),e.jsx("td",{className:"px-3 py-3 text-sm",children:s.contractor}),e.jsx("td",{className:"px-3 py-3 text-sm",children:s.supervisor}),e.jsx("td",{className:"px-3 py-3 text-sm",children:s.district||e.jsx("span",{className:"opacity-40",children:"-"})}),e.jsx("td",{className:"px-3 py-3 text-sm",children:s.subDistrict||e.jsx("span",{className:"opacity-40",children:"-"})}),e.jsx("td",{className:"px-3 py-3 text-sm",children:s.averageWidth?`${s.averageWidth} m`:e.jsx("span",{className:"opacity-40",children:"-"})}),e.jsx("td",{className:"px-3 py-3 text-sm",children:s.length?`${s.length} m`:e.jsx("span",{className:"opacity-40",children:"-"})}),e.jsx("td",{className:"px-3 py-3 text-sm",children:s.roadHierarchy||e.jsx("span",{className:"opacity-40",children:"-"})}),e.jsx("td",{className:"px-3 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-20 ${r?"bg-gray-600":"bg-gray-200"} rounded-full h-2`,children:e.jsx("div",{className:`${Y(s._progress)} h-2 rounded-full transition-all`,style:{width:`${s._progress}%`}})}),e.jsxs("span",{className:"text-xs font-medium whitespace-nowrap",children:[s._progress.toFixed(1),"%"]})]})}),e.jsx("td",{className:"px-3 py-3 text-sm whitespace-nowrap",children:A(s._value)}),e.jsx("td",{className:"px-3 py-3",children:e.jsx(k,{size:"sm",variant:"secondary",onClick:()=>S(`/projects/${s.id}`),children:l("dashboard.btnView")})})]},s.id))})]})}),m>1&&e.jsxs("div",{className:"flex items-center justify-between mt-4 pt-4 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("p",{className:`text-sm ${r?"text-gray-400":"text-gray-500"}`,children:["Showing ",(o-1)*y+1,"–",Math.min(o*y,p.length)," of ",p.length]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>n(Math.max(1,o-1)),disabled:o<=1,className:`p-2 rounded-lg transition-colors ${o<=1?"opacity-40 cursor-not-allowed":"hover:bg-gray-100 dark:hover:bg-gray-700"}`,children:e.jsx(le,{size:18})}),Array.from({length:Math.min(5,m)},(s,t)=>{let a;return m<=5||o<=3?a=t+1:o>=m-2?a=m-4+t:a=o-2+t,e.jsx("button",{onClick:()=>n(a),className:`w-8 h-8 rounded-lg text-sm font-medium transition-colors ${a===o?"bg-blue-600 text-white":`${r?"hover:bg-gray-700":"hover:bg-gray-100"}`}`,children:a},a)}),e.jsx("button",{onClick:()=>n(Math.min(m,o+1)),disabled:o>=m,className:`p-2 rounded-lg transition-colors ${o>=m?"opacity-40 cursor-not-allowed":"hover:bg-gray-100 dark:hover:bg-gray-700"}`,children:e.jsx(ie,{size:18})})]})]})]})]})]})}export{ke as default};
