import{u as q,b as p,c as g}from"./vendor-query-dOYxXkJ3.js";import{s}from"./index-DaHXQ4-S.js";function _(t){const e=(t.boq_items||[]).map(i=>({id:i.id,itemNumber:i.item_number,description:i.description,unit:i.unit,quantity:Number(i.quantity),unitPrice:Number(i.unit_price)})),r=(t.weekly_reports||[]).map(i=>{const d=(i.item_progress||[]).map(a=>({boqItemId:a.boq_item_id,quantity:Number(a.quantity)})),m=(t.photos||[]).filter(a=>a.weekly_report_id===i.id).map(a=>({id:a.id,url:a.url,caption:a.caption||void 0,createdAt:a.created_at}));return{id:i.id,weekNumber:i.week_number,startDate:i.start_date,endDate:i.end_date,workDescription:i.work_description,itemProgress:d,photos:m,createdAt:i.created_at}}),o=(t.photos||[]).filter(i=>!i.weekly_report_id).map(i=>({id:i.id,url:i.url,caption:i.caption||void 0,createdAt:i.created_at}));return{id:t.id,name:t.name,contractor:t.contractor,supervisor:t.supervisor,contractPrice:String(t.contract_price),workType:t.work_type,roadHierarchy:t.road_hierarchy,maintenanceType:t.maintenance_type,startDate:t.start_date,endDate:t.end_date,length:Number(t.length),averageWidth:Number(t.average_width),location:t.location_lat&&t.location_lng?[Number(t.location_lat),Number(t.location_lng)]:null,district:t.district,subDistrict:t.sub_district,boq:e,weeklyReports:r,photos:o,createdAt:t.created_at,updatedAt:t.updated_at}}function v(t){const e={};return t.id!==void 0&&(e.id=t.id),t.name!==void 0&&(e.name=t.name),t.contractor!==void 0&&(e.contractor=t.contractor),t.supervisor!==void 0&&(e.supervisor=t.supervisor),t.contractPrice!==void 0&&(e.contract_price=Number(t.contractPrice)||0),t.workType!==void 0&&(e.work_type=t.workType),t.roadHierarchy!==void 0&&(e.road_hierarchy=t.roadHierarchy),t.maintenanceType!==void 0&&(e.maintenance_type=t.maintenanceType),t.startDate!==void 0&&(e.start_date=t.startDate),t.endDate!==void 0&&(e.end_date=t.endDate),t.length!==void 0&&(e.length=t.length),t.averageWidth!==void 0&&(e.average_width=t.averageWidth),t.location!==void 0&&(t.location?(e.location_lat=t.location[0],e.location_lng=t.location[1]):(e.location_lat=null,e.location_lng=null)),t.district!==void 0&&(e.district=t.district),t.subDistrict!==void 0&&(e.sub_district=t.subDistrict),e}const h=`
  *,
  boq_items(*),
  weekly_reports(
    *,
    item_progress(*)
  ),
  photos(*)
`,y={async uploadPhoto(t,e){const r=t.name.split(".").pop(),o=`${e}/${crypto.randomUUID()}.${r}`,{error:i}=await s.storage.from("project-photos").upload(o,t);if(i)throw i;const{data:d}=s.storage.from("project-photos").getPublicUrl(o);return d.publicUrl},async getAll(){const{data:t,error:e}=await s.from("projects").select(h).order("created_at",{ascending:!1});if(e)throw e;return(t||[]).map(_)},async getById(t){const{data:e,error:r}=await s.from("projects").select(h).eq("id",t).single();if(r){if(r.code==="PGRST116")return;throw r}return e?_(e):void 0},async create(t){const e=v(t),{error:r}=await s.from("projects").insert([e]);if(r)throw r;return await this._syncRelations(t.id,t.boq||[],t.weeklyReports||[],t.photos||[]),t.id},async update(t,e){const r=v(e);if(Object.keys(r).length>0){const{error:o}=await s.from("projects").update(r).eq("id",t);if(o)throw o}if(e.boq||e.weeklyReports||e.photos){const o=await this.getById(t);if(!o)throw new Error("Project not found during update");const i=e.boq!==void 0?e.boq:o.boq,d=e.weeklyReports!==void 0?e.weeklyReports:o.weeklyReports,m=e.photos!==void 0?e.photos:o.photos;await this._syncRelations(t,i,d,m)}return 1},async delete(t){const{error:e}=await s.from("projects").delete().eq("id",t);if(e)throw e},async search(t){const{data:e,error:r}=await s.from("projects").select(h).or(`name.ilike.%${t}%,contractor.ilike.%${t}%`).order("created_at",{ascending:!1});if(r)throw r;return(e||[]).map(_)},async _syncRelations(t,e,r,o){const{error:i}=await s.from("boq_items").delete().eq("project_id",t);if(i)throw i;const{error:d}=await s.from("weekly_reports").delete().eq("project_id",t);if(d)throw d;const{error:m}=await s.from("photos").delete().eq("project_id",t);if(m)throw m;if(e.length>0){const n=e.map(l=>({id:l.id,project_id:t,item_number:l.itemNumber,description:l.description,unit:l.unit,quantity:l.quantity,unit_price:l.unitPrice})),{error:u}=await s.from("boq_items").insert(n);if(u)throw u}if(r.length>0){const n=r.map(c=>({id:c.id,project_id:t,week_number:c.weekNumber,start_date:c.startDate,end_date:c.endDate,work_description:c.workDescription,created_at:c.createdAt||new Date().toISOString()})),{error:u}=await s.from("weekly_reports").insert(n);if(u)throw u;const l=[];if(r.forEach(c=>{c.itemProgress&&c.itemProgress.length>0&&c.itemProgress.forEach(b=>{l.push({weekly_report_id:c.id,boq_item_id:b.boqItemId,quantity:b.quantity})})}),l.length>0){const{error:c}=await s.from("item_progress").insert(l);if(c)throw c}}let a=[];if(o.length>0&&(a=a.concat(o.map(n=>({id:n.id,project_id:t,url:n.url,caption:n.caption,created_at:n.createdAt||new Date().toISOString()})))),r.forEach(n=>{n.photos&&n.photos.length>0&&(a=a.concat(n.photos.map(u=>({id:u.id,weekly_report_id:n.id,project_id:t,url:u.url,caption:u.caption,created_at:u.createdAt||new Date().toISOString()}))))}),a.length>0){const{error:n}=await s.from("photos").insert(a);if(n)throw n}}},E=Object.freeze(Object.defineProperty({__proto__:null,projectService:y},Symbol.toStringTag,{value:"Module"})),f={all:["projects"],detail:t=>["projects",t]};function S(){return q({queryKey:f.all,queryFn:()=>y.getAll()})}function I(t){return q({queryKey:f.detail(t),queryFn:()=>y.getById(t),enabled:!!t})}function N(){const t=p();return g({mutationFn:e=>y.create(e),onSuccess:()=>{t.invalidateQueries({queryKey:f.all})}})}function R(){const t=p();return g({mutationFn:({id:e,updates:r})=>y.update(e,r),onSuccess:(e,r)=>{t.invalidateQueries({queryKey:f.all}),t.invalidateQueries({queryKey:f.detail(r.id)})}})}function T(){const t=p();return g({mutationFn:e=>y.delete(e),onSuccess:()=>{t.invalidateQueries({queryKey:f.all})}})}const A=t=>t?new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(t):"Rp 0",F=t=>{if(!t)return"-";try{return new Date(t).toLocaleDateString("id-ID",{day:"numeric",month:"short",year:"numeric"})}catch{return t}},Q=t=>t?t>=1e3?`${(t/1e3).toFixed(2)} km`:`${t.toFixed(2)} m`:"0 m",U=t=>t?t>=1e4?`${(t/1e4).toFixed(2)} ha`:`${t.toFixed(2)} mÂ²`:"0 mÂ²",$=()=>crypto.randomUUID(),w=t=>!t||!Array.isArray(t)?0:t.reduce((e,r)=>{const o=Number(r.quantity)||0,i=Number(r.unitPrice)||0;return e+o*i},0),D=t=>{const e={};if(!t)return e;for(const r of t)if(r.itemProgress)for(const o of r.itemProgress)e[o.boqItemId]=(e[o.boqItemId]||0)+o.quantity;return e},x=(t,e)=>{if(!t||t.length===0)return 0;const r=w(t);if(r===0)return 0;const o=D(e||[]),i=t.reduce((d,m)=>{const a=o[m.id||""]||0;return d+a*(m.unitPrice||0)},0);return Math.min(100,i/r*100)};export{Q as a,I as b,x as c,N as d,R as e,A as f,$ as g,T as h,w as i,D as j,F as k,U as l,E as m,S as u};
