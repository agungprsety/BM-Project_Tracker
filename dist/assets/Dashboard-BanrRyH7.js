import{j as e}from"./vendor-query-dOYxXkJ3.js";import{f as Y,a as o}from"./vendor-react-CfkJOBur.js";import{u as G}from"./index-kT17AKTn.js";import{u as U,c as X,f as M,a as O}from"./utils-DGZViaHi.js";import{e as J}from"./exportPdf-C86UXNxD.js";import{D as z}from"./districts-Z7EIMGL1.js";import{B as w,C as h}from"./Button-Dqt4D0nT.js";import{j as Q,f as Z,g as ee,k as se,l as te,h as re,C as ae}from"./vendor-icons-Jh-DJkRq.js";import{R as le,B as ie,X as oe,Y as ce,T as ne,a as de,C as me}from"./vendor-charts-D7W35Enl.js";import"./vendor-pdf-D-ScUWta.js";import"./vendor-supabase-Dq-Jb853.js";const b=10,F=[{label:"0–25%",key:"low",color:"#dc2626",min:0,max:25},{label:"25–50%",key:"mid",color:"#d97706",min:25,max:50},{label:"50–75%",key:"high",color:"#2563eb",min:50,max:75},{label:"75–100%",key:"done",color:"#16a34a",min:75,max:101}];function Ce(){const k=Y(),{darkMode:a}=G(),{data:g=[],isLoading:L}=U(),[p,S]=o.useState(""),[y,B]=o.useState("progress"),[v,D]=o.useState("asc"),[R,c]=o.useState(1),[x,j]=o.useState(null),[n,$]=o.useState(""),[f,C]=o.useState(""),d=o.useMemo(()=>g.map(s=>{var t;return{...s,_progress:X(s.boq||[],s.weeklyReports||[]),_value:((t=s.boq)==null?void 0:t.reduce((r,l)=>r+l.quantity*l.unitPrice,0))||0}}),[g]),T=d.reduce((s,t)=>s+t._value,0),E=d.length>0?d.reduce((s,t)=>s+t._progress,0)/d.length:0,W=d.reduce((s,t)=>s+(t.length||0),0),N=o.useMemo(()=>{let s=[...d];if(p){const t=p.toLowerCase();s=s.filter(r=>r.name.toLowerCase().includes(t)||r.contractor.toLowerCase().includes(t)||r.supervisor.toLowerCase().includes(t))}return n&&(s=s.filter(t=>t.district===n)),f&&(s=s.filter(t=>t.subDistrict===f)),s},[d,p,n,f]),P=o.useMemo(()=>F.map(s=>({...s,count:N.filter(t=>t._progress>=s.min&&t._progress<s.max).length})),[N]),H=o.useMemo(()=>{if(!n)return[];const s=z.find(t=>t.name===n);return s?s.subDistricts:[]},[n]),u=o.useMemo(()=>{let s=[...N];if(x){const t=F.find(r=>r.key===x);t&&(s=s.filter(r=>r._progress>=t.min&&r._progress<t.max))}return s.sort((t,r)=>{let l=0;switch(y){case"name":l=t.name.localeCompare(r.name);break;case"contractor":l=t.contractor.localeCompare(r.contractor);break;case"supervisor":l=t.supervisor.localeCompare(r.supervisor);break;case"progress":l=t._progress-r._progress;break;case"value":l=t._value-r._value;break;case"district":l=(t.district||"").localeCompare(r.district||"");break;case"subDistrict":l=(t.subDistrict||"").localeCompare(r.subDistrict||"");break;case"averageWidth":l=(t.averageWidth||0)-(r.averageWidth||0);break;case"length":l=(t.length||0)-(r.length||0);break;case"roadHierarchy":l=(t.roadHierarchy||"").localeCompare(r.roadHierarchy||"");break}return v==="asc"?l:-l}),s},[N,x,y,v]),m=Math.max(1,Math.ceil(u.length/b)),i=Math.min(R,m),_=u.slice((i-1)*b,i*b),K=x||n||f||p,q=()=>{j(null),$(""),C(""),S(""),c(1)},V=s=>{y===s?D(v==="asc"?"desc":"asc"):(B(s),D("asc")),c(1)},I=s=>s>=75?"bg-green-500":s>=50?"bg-blue-500":s>=25?"bg-amber-500":"bg-red-500",A=`px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${a?"bg-gray-700 border-gray-600 text-white":"bg-white border-gray-300"}`;return L?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"max-w-7xl mx-auto",children:[g.length>0&&e.jsx("div",{className:"flex justify-end mb-4",children:e.jsxs(w,{variant:"secondary",size:"sm",onClick:()=>J(g),children:[e.jsx(Q,{size:16,className:"mr-2"})," Export PDF"]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8",children:[e.jsxs(h,{darkMode:a,children:[e.jsx("p",{className:`text-sm font-medium mb-2 ${a?"text-gray-400":"text-gray-600"}`,children:"Total Projects"}),e.jsx("p",{className:"text-3xl font-bold",children:g.length})]}),e.jsxs(h,{darkMode:a,children:[e.jsx("p",{className:`text-sm font-medium mb-2 ${a?"text-gray-400":"text-gray-600"}`,children:"Total Value"}),e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:M(T)})]}),e.jsxs(h,{darkMode:a,children:[e.jsx("p",{className:`text-sm font-medium mb-2 ${a?"text-gray-400":"text-gray-600"}`,children:"Avg Progress"}),e.jsxs("p",{className:"text-2xl font-bold text-green-600",children:[E.toFixed(1),"%"]})]}),e.jsxs(h,{darkMode:a,children:[e.jsx("p",{className:`text-sm font-medium mb-2 ${a?"text-gray-400":"text-gray-600"}`,children:"Total Length"}),e.jsx("p",{className:"text-2xl font-bold text-purple-600",children:O(W)})]})]}),g.length===0?e.jsxs(h,{darkMode:a,className:"text-center py-12",children:[e.jsx("p",{className:`text-lg mb-4 ${a?"text-gray-400":"text-gray-600"}`,children:"No projects yet"}),e.jsx(w,{onClick:()=>k("/projects/new"),children:"Create Your First Project"})]}):e.jsxs(e.Fragment,{children:[e.jsxs(h,{darkMode:a,className:"mb-8",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Progress Distribution"}),e.jsx("p",{className:`text-sm ${a?"text-gray-400":"text-gray-500"}`,children:"Click a bar to filter the table below"})]}),x&&e.jsx("button",{onClick:()=>{j(null),c(1)},className:"text-sm text-blue-600 hover:text-blue-700 font-medium",children:"Clear filter ×"})]}),e.jsx(le,{width:"100%",height:180,children:e.jsxs(ie,{data:P,margin:{left:15,right:10,top:10,bottom:20},children:[e.jsx(oe,{dataKey:"label",tick:{fontSize:12},label:{value:"Progress (%)",position:"insideBottom",offset:-15,fontSize:12}}),e.jsx(ce,{allowDecimals:!1,tick:{fontSize:12},label:{value:"No. of Projects",angle:-90,position:"insideLeft",offset:-5,fontSize:12}}),e.jsx(ne,{formatter:s=>[`${s} projects`,"Count"],contentStyle:a?{backgroundColor:"#1f2937",border:"1px solid #374151",borderRadius:"8px"}:{borderRadius:"8px"}}),e.jsx(de,{dataKey:"count",radius:[4,4,0,0],cursor:"pointer",onClick:s=>{x===s.key?j(null):j(s.key),c(1)},children:P.map((s,t)=>e.jsx(me,{fill:s.color,opacity:x&&x!==s.key?.3:1},t))})]})})]}),e.jsxs(h,{darkMode:a,children:[e.jsxs("div",{className:"flex flex-col gap-3 mb-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3",children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["All Projects",u.length!==d.length&&e.jsxs("span",{className:`text-sm font-normal ml-2 ${a?"text-gray-400":"text-gray-500"}`,children:["(",u.length," of ",d.length,")"]})]}),e.jsxs("div",{className:"relative w-full sm:w-64",children:[e.jsx(Z,{size:16,className:`absolute left-3 top-1/2 -translate-y-1/2 ${a?"text-gray-500":"text-gray-400"}`}),e.jsx("input",{type:"text",placeholder:"Search name, contractor, consultant...",value:p,onChange:s=>{S(s.target.value),c(1)},className:`w-full pl-9 pr-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors ${a?"bg-gray-700 border-gray-600 text-white placeholder-gray-400":"bg-white border-gray-300 placeholder-gray-400"}`})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx(ee,{size:16,className:a?"text-gray-400":"text-gray-500"}),e.jsxs("select",{value:n,onChange:s=>{$(s.target.value),C(""),c(1)},className:A,children:[e.jsx("option",{value:"",children:"All Districts"}),z.map(s=>e.jsx("option",{value:s.name,children:s.name},s.code))]}),e.jsxs("select",{value:f,onChange:s=>{C(s.target.value),c(1)},className:A,disabled:!n,children:[e.jsx("option",{value:"",children:"All Sub-districts"}),H.map(s=>e.jsx("option",{value:s,children:s},s))]}),K&&e.jsx("button",{onClick:q,className:"text-sm text-blue-600 hover:text-blue-700 font-medium ml-auto",children:"Clear all filters ×"})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:a?"bg-gray-700 text-gray-300":"bg-gray-50 text-gray-500",children:[[["name","Project"],["contractor","Contractor"],["supervisor","Consultant"],["district","District"],["subDistrict","Sub-district"],["averageWidth","Avg Width"],["length","Length"],["roadHierarchy","Hierarchy"],["progress","Progress"],["value","Value"]].map(([s,t])=>e.jsx("th",{className:"px-3 py-3 text-left text-xs font-medium cursor-pointer select-none hover:text-blue-600 transition-colors whitespace-nowrap",onClick:()=>V(s),children:e.jsxs("span",{className:"flex items-center gap-1",children:[t,e.jsx(se,{size:11,className:y===s?"text-blue-500":"opacity-40"})]})},s)),e.jsx("th",{className:"px-3 py-3 text-left text-xs font-medium",children:"Actions"})]})}),e.jsx("tbody",{children:_.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"px-4 py-8 text-center",children:e.jsx("p",{className:a?"text-gray-400":"text-gray-500",children:"No projects match your filters."})})}):_.map(s=>e.jsxs("tr",{className:`border-t ${a?"border-gray-700 hover:bg-gray-700":"border-gray-200 hover:bg-gray-50"} transition-colors`,children:[e.jsxs("td",{className:"px-3 py-3",children:[e.jsx("div",{className:"font-medium",children:s.name}),s.location&&e.jsxs("div",{className:`text-xs ${a?"text-gray-400":"text-gray-500"}`,children:[e.jsx(te,{size:10,className:"inline mr-0.5"}),"GPS"]})]}),e.jsx("td",{className:"px-3 py-3 text-sm",children:s.contractor}),e.jsx("td",{className:"px-3 py-3 text-sm",children:s.supervisor}),e.jsx("td",{className:"px-3 py-3 text-sm",children:s.district||e.jsx("span",{className:"opacity-40",children:"-"})}),e.jsx("td",{className:"px-3 py-3 text-sm",children:s.subDistrict||e.jsx("span",{className:"opacity-40",children:"-"})}),e.jsx("td",{className:"px-3 py-3 text-sm",children:s.averageWidth?`${s.averageWidth} m`:e.jsx("span",{className:"opacity-40",children:"-"})}),e.jsx("td",{className:"px-3 py-3 text-sm",children:s.length?`${s.length} m`:e.jsx("span",{className:"opacity-40",children:"-"})}),e.jsx("td",{className:"px-3 py-3 text-sm",children:s.roadHierarchy||e.jsx("span",{className:"opacity-40",children:"-"})}),e.jsx("td",{className:"px-3 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-20 ${a?"bg-gray-600":"bg-gray-200"} rounded-full h-2`,children:e.jsx("div",{className:`${I(s._progress)} h-2 rounded-full transition-all`,style:{width:`${s._progress}%`}})}),e.jsxs("span",{className:"text-xs font-medium whitespace-nowrap",children:[s._progress.toFixed(1),"%"]})]})}),e.jsx("td",{className:"px-3 py-3 text-sm whitespace-nowrap",children:M(s._value)}),e.jsx("td",{className:"px-3 py-3",children:e.jsx(w,{size:"sm",variant:"secondary",onClick:()=>k(`/projects/${s.id}`),children:"View"})})]},s.id))})]})}),m>1&&e.jsxs("div",{className:"flex items-center justify-between mt-4 pt-4 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("p",{className:`text-sm ${a?"text-gray-400":"text-gray-500"}`,children:["Showing ",(i-1)*b+1,"–",Math.min(i*b,u.length)," of ",u.length]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>c(Math.max(1,i-1)),disabled:i<=1,className:`p-2 rounded-lg transition-colors ${i<=1?"opacity-40 cursor-not-allowed":"hover:bg-gray-100 dark:hover:bg-gray-700"}`,children:e.jsx(re,{size:18})}),Array.from({length:Math.min(5,m)},(s,t)=>{let r;return m<=5||i<=3?r=t+1:i>=m-2?r=m-4+t:r=i-2+t,e.jsx("button",{onClick:()=>c(r),className:`w-8 h-8 rounded-lg text-sm font-medium transition-colors ${r===i?"bg-blue-600 text-white":`${a?"hover:bg-gray-700":"hover:bg-gray-100"}`}`,children:r},r)}),e.jsx("button",{onClick:()=>c(Math.min(m,i+1)),disabled:i>=m,className:`p-2 rounded-lg transition-colors ${i>=m?"opacity-40 cursor-not-allowed":"hover:bg-gray-100 dark:hover:bg-gray-700"}`,children:e.jsx(ae,{size:18})})]})]})]})]})]})}export{Ce as default};
