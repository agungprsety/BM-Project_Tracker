import{j as a}from"./vendor-query-dOYxXkJ3.js";import{a as c,f as M,j as H}from"./vendor-react-CfkJOBur.js";import{u as W}from"./index-DaHXQ4-S.js";import{b as B,d as _,e as z,g as F}from"./utils-BfptotOI.js";import{D as C}from"./districts-Z7EIMGL1.js";import{C as U,B as T}from"./Button-Dqt4D0nT.js";import{I as b}from"./Input-8WHCH_aK.js";import{M as K,T as $,a as G,P as q,u as V,L as X}from"./vendor-maps-CQh9FGhc.js";import{l as I}from"./vendor-icons-Jh-DJkRq.js";import"./vendor-pdf-D-ScUWta.js";import"./vendor-supabase-Dq-Jb853.js";var N=(r=>(r.RIGID_PAVEMENT="rigid-pavement",r.FLEXIBLE_PAVEMENT="flexible-pavement",r.COMBINATION="combination",r.OTHER="other",r))(N||{}),v=(r=>(r.JAS="JAS",r.JKS="JKS",r.JLS="JLS",r.JLING_S="Jling-S",r.JLING_KOTA="J-ling Kota",r))(v||{}),y=(r=>(r.RECONSTRUCTION="reconstruction",r.REHABILITATION="rehabilitation",r.PERIODIC_REHABILITATION="periodic-rehabilitation",r.ROUTINE_MAINTENANCE="routine-maintenance",r))(y||{});const f=c.forwardRef(({className:r="",label:n,error:i,options:m,id:s,...x},h)=>{const e=s||(n==null?void 0:n.toLowerCase().replace(/\s/g,"-"));return a.jsxs("div",{className:"w-full",children:[n&&a.jsx("label",{htmlFor:e,className:"block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300",children:n}),a.jsx("select",{ref:h,id:e,className:`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:border-blue-500 transition-colors
            ${i?"border-red-500":"border-gray-300 dark:border-gray-600"}
            bg-white dark:bg-gray-700 dark:text-white
            focus:ring-blue-500 focus:border-blue-500
            ${r}`,...x,children:m.map(g=>a.jsx("option",{value:g.value,children:g.label},g.value))}),i&&a.jsx("p",{className:"mt-1 text-sm text-red-500",children:i})]})});f.displayName="Select";const Z=r=>X.divIcon({html:`<div class="w-10 h-10 rounded-full flex items-center justify-center ${r?"bg-blue-700":"bg-blue-600"} text-white shadow-lg border-2 ${r?"border-gray-800":"border-white"}">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
            </svg>
          </div>`,className:"custom-marker",iconSize:[40,40],iconAnchor:[20,40],popupAnchor:[0,-40]}),Q=({center:r})=>{const n=V();return c.useEffect(()=>{n.flyTo(r,16,{duration:1})},[r,n]),null};function Y({position:r,onChange:n,darkMode:i=!1}){const[m,s]=c.useState(null),[x,h]=c.useState(!1),[e,g]=c.useState(null),d=c.useRef(!1);c.useEffect(()=>{if(!d.current){if(d.current=!0,r){s(r);return}navigator.geolocation?(h(!0),navigator.geolocation.getCurrentPosition(o=>{const{latitude:j,longitude:p}=o.coords,E=[j,p];n(E),s(E),h(!1)},o=>{g(o.message),h(!1),s([-6.2088,106.8456])},{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5})):s([-6.2088,106.8456])}},[r,n]);const D=()=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(o=>{const{latitude:j,longitude:p}=o.coords;n([j,p])},o=>{console.error("Error getting location:",o),alert("Unable to get current location. Please enable location services.")}):alert("Geolocation is not supported by your browser.")};return a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("label",{className:`block text-sm font-medium ${i?"text-gray-300":"text-gray-700"}`,children:"Project Location"}),a.jsxs("button",{type:"button",onClick:D,className:"flex items-center gap-2 px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm",children:[a.jsx(I,{size:14}),"Use Current Location"]})]}),a.jsxs("div",{className:"h-64 rounded-lg overflow-hidden border border-gray-300 dark:border-gray-600 relative",children:[x&&a.jsx("div",{className:"absolute inset-0 z-[1000] bg-black/30 flex items-center justify-center",children:a.jsxs("div",{className:"bg-white dark:bg-gray-800 px-4 py-2 rounded-lg shadow-lg flex items-center gap-2",children:[a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"}),a.jsx("span",{className:"text-sm dark:text-white",children:"Getting your location..."})]})}),a.jsxs(K,{center:m||[-6.2088,106.8456],zoom:13,style:{height:"100%",width:"100%"},scrollWheelZoom:!0,children:[a.jsx($,{attribution:'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),m&&a.jsx(Q,{center:m}),r&&a.jsx(G,{position:r,icon:Z(i),draggable:!0,eventHandlers:{dragend:o=>{const p=o.target.getLatLng();n([p.lat,p.lng])}},children:a.jsx(q,{children:a.jsxs("div",{className:"text-sm",children:[a.jsx("p",{className:"font-semibold",children:"Project Location"}),a.jsxs("p",{children:["Lat: ",r[0].toFixed(6)]}),a.jsxs("p",{children:["Lng: ",r[1].toFixed(6)]})]})})})]})]}),r&&a.jsxs("div",{className:`p-3 rounded-lg ${i?"bg-gray-700":"bg-gray-50"}`,children:[a.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[a.jsx(I,{size:14,className:i?"text-blue-400":"text-blue-600"}),a.jsxs("span",{className:i?"text-gray-300":"text-gray-700",children:["Selected Location: ",r[0].toFixed(6),", ",r[1].toFixed(6)]})]}),a.jsx("div",{className:"text-xs mt-1 opacity-70",children:"Click on the map to select location or drag the marker to adjust"})]}),e&&a.jsx("div",{className:"p-3 rounded-lg bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800",children:a.jsxs("p",{className:"text-sm text-red-600 dark:text-red-400",children:["Could not get GPS location: ",e,". Please select manually."]})})]})}const ee={name:"",contractor:"",supervisor:"",workType:N.FLEXIBLE_PAVEMENT,roadHierarchy:v.JAS,maintenanceType:y.RECONSTRUCTION,startDate:"",endDate:"",length:"",averageWidth:"",location:null,district:"",subDistrict:""};function me(){const r=M(),{id:n}=H(),i=!!n,{darkMode:m}=W(),{data:s}=B(n),x=_(),h=z(),[e,g]=c.useState(ee),[d,D]=c.useState({}),[o,j]=c.useState(!1),p=c.useMemo(()=>{if(!e.district)return[];const t=C.find(u=>u.name===e.district);return t?t.subDistricts.map(u=>({value:u,label:u})):[]},[e.district]);c.useEffect(()=>{i&&s&&!o&&(g({name:s.name,contractor:s.contractor,supervisor:s.supervisor,workType:s.workType,roadHierarchy:s.roadHierarchy,maintenanceType:s.maintenanceType,startDate:s.startDate,endDate:s.endDate,length:String(s.length),averageWidth:String(s.averageWidth),location:s.location,district:s.district||"",subDistrict:s.subDistrict||""}),j(!0))},[i,s,o]);const E=()=>{const t={};return e.name.trim()||(t.name="Project name is required"),e.contractor.trim()||(t.contractor="Contractor is required"),e.supervisor.trim()||(t.supervisor="Supervisor is required"),e.startDate||(t.startDate="Start date is required"),e.endDate||(t.endDate="End date is required"),e.startDate&&e.endDate&&e.startDate>e.endDate&&(t.endDate="End date must be after start date"),(!e.length||isNaN(Number(e.length))||Number(e.length)<=0)&&(t.length="Length must be a positive number"),(!e.averageWidth||isNaN(Number(e.averageWidth))||Number(e.averageWidth)<=0)&&(t.averageWidth="Average width must be a positive number"),D(t),Object.keys(t).length===0},w=()=>{if(!E())return;const t=new Date().toISOString();if(i&&n)h.mutate({id:n,updates:{name:e.name,contractor:e.contractor,supervisor:e.supervisor,workType:e.workType,roadHierarchy:e.roadHierarchy,maintenanceType:e.maintenanceType,startDate:e.startDate,endDate:e.endDate,length:Number(e.length),averageWidth:Number(e.averageWidth),location:e.location,district:e.district,subDistrict:e.subDistrict}},{onSuccess:()=>r(`/projects/${n}`)});else{const u={id:F(),name:e.name,contractor:e.contractor,supervisor:e.supervisor,contractPrice:"0",workType:e.workType,roadHierarchy:e.roadHierarchy,maintenanceType:e.maintenanceType,startDate:e.startDate,endDate:e.endDate,length:Number(e.length),averageWidth:Number(e.averageWidth),location:e.location,district:e.district,subDistrict:e.subDistrict,boq:[],weeklyReports:[],photos:[],createdAt:t,updatedAt:t};x.mutate(u,{onSuccess:()=>r("/dashboard")})}},l=(t,u)=>{g(S=>({...S,[t]:u})),d[t]&&D(S=>({...S,[t]:void 0}))},L=t=>{g(u=>({...u,district:t,subDistrict:""}))},P=x.isPending||h.isPending,A=[{value:"",label:"-- Select District --"},...C.map(t=>({value:t.name,label:`${t.name} (${t.code})`}))],O=[{value:"",label:e.district?"-- Select Sub-district --":"-- Select district first --"},...p],k=[{value:N.RIGID_PAVEMENT,label:"Rigid Pavement"},{value:N.FLEXIBLE_PAVEMENT,label:"Flexible Pavement"},{value:N.COMBINATION,label:"Combination"},{value:N.OTHER,label:"Other"}],R=[{value:v.JAS,label:"JAS"},{value:v.JKS,label:"JKS"},{value:v.JLS,label:"JLS"},{value:v.JLING_S,label:"Jling-S"},{value:v.JLING_KOTA,label:"J-ling Kota"}],J=[{value:y.RECONSTRUCTION,label:"Reconstruction"},{value:y.REHABILITATION,label:"Rehabilitation"},{value:y.PERIODIC_REHABILITATION,label:"Periodic Rehabilitation"},{value:y.ROUTINE_MAINTENANCE,label:"Routine Maintenance"}];return a.jsx("div",{className:"max-w-4xl mx-auto",children:a.jsxs(U,{darkMode:m,children:[a.jsx("h2",{className:`text-2xl font-bold mb-6 border-b pb-2 ${m?"border-gray-700":"border-gray-200"}`,children:i?"Edit Project":"Create New Project"}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[a.jsx(b,{label:"Project Name *",value:e.name,onChange:t=>l("name",t.target.value),error:d.name,placeholder:"Enter project name"}),a.jsx(b,{label:"Contractor *",value:e.contractor,onChange:t=>l("contractor",t.target.value),error:d.contractor,placeholder:"Enter contractor name"}),a.jsx(b,{label:"Supervisor *",value:e.supervisor,onChange:t=>l("supervisor",t.target.value),error:d.supervisor,placeholder:"Enter supervisor name"}),a.jsx(b,{label:"Length (meters) *",type:"number",value:e.length,onChange:t=>l("length",t.target.value),error:d.length,placeholder:"Enter road length",min:"0",step:"0.01"}),a.jsx(b,{label:"Average Width (meters) *",type:"number",value:e.averageWidth,onChange:t=>l("averageWidth",t.target.value),error:d.averageWidth,placeholder:"Enter average width",min:"0",step:"0.01"}),a.jsx(f,{label:"Work Type",value:e.workType,onChange:t=>l("workType",t.target.value),options:k}),a.jsx(f,{label:"Road Hierarchy",value:e.roadHierarchy,onChange:t=>l("roadHierarchy",t.target.value),options:R}),a.jsx(f,{label:"Maintenance Type",value:e.maintenanceType,onChange:t=>l("maintenanceType",t.target.value),options:J}),a.jsx(f,{label:"District (Kecamatan)",value:e.district,onChange:t=>L(t.target.value),options:A}),a.jsx(f,{label:"Sub-district (Kelurahan)",value:e.subDistrict,onChange:t=>l("subDistrict",t.target.value),options:O,disabled:!e.district}),a.jsx(b,{label:"Start Date *",type:"date",value:e.startDate,onChange:t=>l("startDate",t.target.value),error:d.startDate}),a.jsx(b,{label:"End Date *",type:"date",value:e.endDate,onChange:t=>l("endDate",t.target.value),error:d.endDate,min:e.startDate})]}),a.jsx("div",{className:"mt-6",children:a.jsx(Y,{position:e.location,onChange:t=>l("location",t),darkMode:m})}),a.jsxs("div",{className:"flex gap-3 mt-8 pt-6 border-t border-gray-700",children:[a.jsx(T,{onClick:w,isLoading:P,children:i?"Update Project":"Create Project"}),a.jsx(T,{variant:"secondary",onClick:()=>r("/dashboard"),children:"Cancel"})]})]})})}export{me as default};
